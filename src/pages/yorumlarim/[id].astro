---
import Layout from '~/layouts/PageLayout.astro';
import { supabase } from '~/utils/supabase';


// This function tells Astro which pages to generate at build time.
export async function getStaticPaths() {
  const { data: posts, error } = await supabase.from('posts').select('id');

  if (error) {
    console.error('Error fetching post IDs for getStaticPaths:', error.message);
    return []; // Return empty array on error
  }

  // We need to return an array of objects with `params`
  return posts.map(({ id }) => ({
    params: { id: String(id) },
  }));
}

const { id } = Astro.params;

// Fetch the single post data based on the id from the URL
const { data: post, error } = await supabase
  .from('posts') // Correct table name
  .select('*')
  .eq('id', id)
  .single();

// If the post is not found, redirect to 404
if (error || !post) {
  console.error(`Error fetching post with id ${id}:`, error?.message);
  return Astro.redirect('/404');
}

const metadata = {
  title: post.title,
  description: post.content.substring(0, 160),
};
---

<Layout metadata={metadata}>
  <section class="py-16 sm:py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-3xl mx-auto">
        <!-- Post Title and Address -->
        <div class="text-center mb-8">
          <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 text-gray-900 dark:text-white">
            {post.title}
          </h1>
          {post.address && (
            <p class="text-lg text-gray-500 dark:text-slate-400 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
              </svg>
              {post.address}
            </p>
          )}
        </div>

        <!-- Post Image -->
        <div class="mb-8">
          <img 
            src={post.image_url}
            alt={post.title} 
            class="w-full h-auto max-h-[500px] object-cover rounded-lg shadow-lg"
          />
        </div>

        <!-- Post Content -->
        <div class="prose prose-lg max-w-none mx-auto text-gray-600 dark:text-slate-300 dark:prose-invert">
          <p>{post.content}</p>
        </div>

        <!-- Separator -->
        <hr class="my-12 border-t border-gray-200 dark:border-slate-700" />

        <!-- Comments Section -->
        

      </div>
    </div>
  </section>
</Layout>
